<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RunComfy Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { margin:0; padding:0; background:#111; color:#fff; font-family:sans-serif; }
    .container { max-width:900px; margin:auto; padding:24px; }
    .panel { background:#222; padding:20px; border-radius:10px; margin-bottom:20px; }
    textarea { width:100%; height:120px; background:#000; color:#fff; padding:10px; border-radius:8px; border:1px solid #333; }
    input[type="file"] { margin-top:10px; }
    button { margin-top:15px; width:100%; padding:12px; background:#4f46e5; border:none; border-radius:8px; color:#fff; cursor:pointer; }
    .output img { max-width:100%; border-radius:8px; margin-top:15px; }
    pre { white-space:pre-wrap; background:#000; padding:10px; border-radius:8px; max-height:200px; overflow-y:auto; }
  </style>
</head>

<body>
  <div class="container">
    <h1>RunComfy Â· Image Workflow Generator</h1>

    <div class="panel">
      <label>Upload reference image</label>
      <input type="file" id="imageInput" accept="image/*">

      <label>Prompt</label>
      <textarea id="prompt">
create turnaround sheet of this character
      </textarea>

      <button onclick="start()">Generate</button>

      <pre id="status"></pre>
    </div>

    <div class="panel output" id="output">
      Output will appear here
    </div>
  </div>

<script>
async function toBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}

async function start() {
  const status = document.getElementById("status");
  const output = document.getElementById("output");
  const file = document.getElementById("imageInput").files[0];
  const prompt = document.getElementById("prompt").value;

  if (!file) { status.textContent = "Please select an image."; return; }

  status.textContent = "Converting image...";
  const imageB64 = await toBase64(file);

  status.textContent = "Sending job to RunComfy...";

  const res = await fetch("/api/generate", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ prompt, image: imageB64 })
  });

  const data = await res.json();
  status.textContent = JSON.stringify(data, null, 2);

  if (!data.request_id) return;

  // poll status
  let done = false;
  while (!done) {
    await new Promise(r => setTimeout(r, 2500));

    const s = await fetch("/api/status?requestId=" + data.request_id);
    const js = await s.json();
    status.textContent = JSON.stringify(js, null, 2);

    if (js.status === "completed") {
      done = true;
    }
  }

  const r = await fetch("/api/result?requestId=" + data.request_id);
  const rj = await r.json();

  status.textContent = JSON.stringify(rj, null, 2);

  // find first image
  for (const node of Object.values(rj.outputs || {})) {
    if (node.images?.length) {
      output.innerHTML = `<img src="${node.images[0].url}" />`;
      return;
    }
  }

  output.textContent = "No image found in results.";
}
</script>

</body>
</html>
